---
title: "HTTP ç¼“å­˜"
date: "2021-03-02"
category: "dev"
emoji: "ğŸ"
---

å®¢æˆ·ç«¯è¯·æ±‚æœåŠ¡å™¨, ä¸­é—´å¯èƒ½ç»è¿‡ç¼“å­˜æœåŠ¡å™¨, è¿™æ˜¯ http åè®®é‡Œçš„,
è§„å®šäº†åŒæ–¹å¦‚ä½•å¯¹å¾…ç¼“å­˜. å…¶ä¸­ç¼“å­˜æœåŠ¡å™¨å¯ä»¥æ˜¯ cdn ä¹Ÿå¯ä»¥æ˜¯ nginx å±‚é…ç½®,
å¯ä»¥æ˜¯å®¢æˆ·ç«¯çš„å†…å­˜/ç¡¬ç›˜, è¿˜å¯ä»¥æ˜¯ç‹¬ç«‹çš„ä¸€ä¸ªæœåŠ¡å™¨,
æ¯”å¦‚å…¬å¸ç»™å±€åŸŸç½‘ä¸‹å°ä¼™ä¼´ä»¬ç»Ÿä¸€é…ç½®äº†ä¸€å°ç¼“å­˜æœåŠ¡å™¨, å¯ä»¥åŠ é€Ÿå±€åŸŸç½‘ä¸‹çš„è¯·æ±‚è®¿é—®.

ä¸ç®¡æ˜¯ä»€ä¹ˆç¼“å­˜æœåŠ¡å™¨, éƒ½è¦éµå®ˆ http è§„åˆ™.

å…¶ä¸­æœ‰ä¸¤ç§ç¼“å­˜ç±»å‹: `cache-control Expires` å’Œ `Last-Modified Etag`.

å®¢æˆ·ç«¯ç¬¬ä¸€æ¬¡è¯·æ±‚, è‚¯å®šæ˜¯æ²¡æœ‰ç¼“å­˜ç”Ÿæˆçš„, å¦‚æœ cache-control æ˜¯ public,
é‚£ä¹ˆç¼“å­˜æœåŠ¡å™¨å°±ä¼šå­˜å‚¨è¯·æ±‚, å±€åŸŸç½‘ä¸‹æ‰€æœ‰ ip å¯¹åŒä¸€ URI çš„ç¼“å­˜è¯·æ±‚éƒ½ä¼šç›´æ¥è¿”å›.
å½“å®¢æˆ·ç«¯ç¬¬äºŒæ¬¡è¯·æ±‚, èµ°äº†ç¼“å­˜, è¿˜ä¼šæ”¶åˆ° 200 çš„çŠ¶æ€ç , æ³¨æ„ä¸æ˜¯ 304 å“¦.

å½“ cache-control ä¸º private, åˆ™åªèƒ½åŒä¸€è®¾å¤‡çš„è¯·æ±‚æ‰ä¼šè¢«ä¹‹é—´è¿”å›,
å¦‚æœå±€åŸŸç½‘ä¸‹å…¶ä»–äººè¯·æ±‚, åˆ™è¿˜ä¼šåˆ°è¾¾æœåŠ¡å™¨.

å½“ cache-control ä¸º no-cache, æˆ–è€…è¯·æ±‚ max-age=0, æ˜¯å¦å°±ä¸èµ°ç¼“å­˜äº†? é”™,
è¿˜ä¼šè¿›è¡Œç¼“å­˜, ä½†ç¼“å­˜æœåŠ¡å™¨ä¼šå»è¯·æ±‚æœåŠ¡å™¨æ˜¯å¦ç¼“å­˜è¿‡æœŸ, å¦‚æœæ²¡æœ‰è¿‡æœŸ,
åˆ™è¿˜ä¼šèµ°ç¼“å­˜, 304 Not Modified.

å½“ cache-control æ˜¯ no-store, åˆ™ä¸èµ°ç¼“å­˜, å®ƒæ‰æ˜¯çœŸæ­£çš„ä¸èµ°ç¼“å­˜.

è¿™é‡Œå†æ¬¡è¯´æ˜ä¸‹, ç”±äº HTTP æ˜¯ C/S ç»“æ„, åªèƒ½é¢„çº¦ä¸€ä¸ªè¿‡æœŸæ—¶é—´,
æ‰€ä»¥ç¼“å­˜åˆ°äº†è¿‡æœŸæ—¶é—´å°±åº”è¯¥å†æ¬¡éªŒè¯æ˜¯å¦è¿‡æœŸ, æ¯”å¦‚è¿‡æœŸåæˆ–è€…å®¢æˆ·ç«¯å‘é€äº†ä¸€ä¸ª
`cache-control: max-age=0`, é‚£ä¹ˆç¼“å­˜æœåŠ¡å™¨ä¼šæ·»åŠ ä¸€ä¸ª `If-None-Match` æˆ–è€…
`If-Modified-Since` å­—æ®µ, æœåŠ¡å™¨ä¼šå¯¹è¿™ä¸ªè¯·æ±‚åŠ ä»¥éªŒè¯, æ²¡æœ‰è¿‡æœŸåˆ™è¿”å› 304,
è¯´æ˜è¿˜æ²¡æœ‰è¿‡æœŸ, è¿‡æœŸäº†çš„è¯, å°±æ­£å¸¸è¿”å› 200 å³å¯.


talk is cheap, show me the code:

ä»¥ä¸‹ä¸¤å—ä»£ç ä½¿ç”¨ Node æ¥å±•ç¤º Last-Modified å’Œ Etag ç­–ç•¥:

```javascript
import http from 'http'

let server = http.createServer((req, res) => {
  console.log(req.url, req.headers['if-none-match'])
  if (req.headers['if-none-match']) {
    // check file version
    res.statusCode = 304
    res.end()
  }
  else {
    res.setHeader('Etag', '00000000')
    res.end('harttle.land')
  }
})

server.listen(3333)
```


```javascript
import http from 'http'

let server = http.createServer((req, res) => {
  console.log(req.url, req.headers['if-modified-since'])
  if (req.headers['if-modified-since']) {
    // check timestamp
    res.statusCode = 304
    res.end()
  }
  else {
    res.setHeader('Last-Modified', new Date().toString())
    res.end('harttle.land')
  }
})

server.listen(3333)
```

å†ç”¨ä¸ªä¾‹å­æ¥è®²è¿°ä¸‹, å®¢æˆ·ç«¯è¯·æ±‚ä¸€å¼ å›¾ç‰‡, ç¼“å­˜æœ‰æ•ˆæœŸæ˜¯1å¤©,
é‚£ä¹ˆè¿‡äº†ä¸€å¤©åå†è¯·æ±‚è¿™å¼ å›¾ç‰‡, ç¼“å­˜æœåŠ¡å™¨éœ€è¦æ£€æŸ¥è¿™å¼ å›¾ç‰‡æ˜¯å¦è¿˜èƒ½ç»§ç»­å¯ç”¨.
ç¼“å­˜æœåŠ¡å™¨æœ‰ä»¥ä¸Šä¸¤ç§ç­–ç•¥, å¦‚æœå›¾ç‰‡æ²¡å˜, è¿˜æ˜¯æ˜¨å¤©çš„å›¾ç‰‡, é‚£ä¹ˆç¼“å­˜æœåŠ¡å™¨å‘é€çš„
`if-none-match` å­—æ®µæ˜¯ä¸€è‡´çš„, æ‰€ä»¥è¿”å› 304; æˆ–è€… `if-modified-since`
å’Œå›¾ç‰‡æœ€åä¿®æ”¹æ—¥æœŸä¸€è‡´, åˆ™æ²¡å˜è¿”å› 304.

å¯¹äºæµè§ˆå™¨, åˆ·æ–°é¡µé¢(cmd+r)åˆ™ä¼šé‡æ–°éªŒè¯ç¼“å­˜, éªŒè¯çš„è¯å°±å¯èƒ½304.

å¦‚æœå¼ºåˆ¶åˆ·æ–°(shift+cmd+r)åˆ™ä¸éªŒè¯ç¼“å­˜ç›´æ¥å’ŒæœåŠ¡å™¨é€šè¯.


