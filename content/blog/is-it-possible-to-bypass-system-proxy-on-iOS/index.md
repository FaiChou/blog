---
title: "é™¤äº† SSL Pining è¿˜æœ‰ä»€ä¹ˆæ–¹æ³•é˜²æ­¢æŠ“åŒ…?"
date: "2020-11-23"
category: "dev"
emoji: "ğŸ“±"
---

ä¸åšä»£ç å·²ä¹…, å…ˆç›²å†™ä¸€æ®µ HTTPS éªŒè¯è¿‡ç¨‹æ¥éªŒè¯æˆ‘çš„åŸºæœ¬åŠŸ:

1. å®¢æˆ·ç«¯å‘æœåŠ¡ç«¯å‘èµ· HTTPS è¯·æ±‚
2. æœåŠ¡å™¨å‘å®¢æˆ·ç«¯å›å¤`è¯ä¹¦`, `è¯ä¹¦`é‡ŒåŒ…å«`å…¬é’¥`
3. å®¢æˆ·ç«¯æ‹¿åˆ°è¯ä¹¦å…ˆå»æƒå¨æœºæ„(ç³»ç»Ÿ)éªŒè¯è¯ä¹¦æ˜¯å¦æœ‰æ•ˆ, å¦‚æœæ— æ•ˆåˆ™ç»ˆæ­¢è¯·æ±‚
4. è¯ä¹¦æœ‰æ•ˆ, äºæ˜¯å°†å®¢æˆ·ç«¯è‡ªå·±çš„`é’¥åŒ™(å¯¹ç§°åŠ å¯†)`ä½¿ç”¨æœåŠ¡ç«¯çš„`å…¬é’¥`åŠ å¯†å‘é€ç»™æœåŠ¡ç«¯
5. æœåŠ¡ç«¯æ”¶åˆ°ä¿¡æ¯, ç”¨è‡ªå·±çš„`ç§é’¥`è§£å¯†å‡ºå®¢æˆ·ç«¯çš„`é’¥åŒ™`
6. äºæ˜¯è¿™ä¸¤è€…å»ºç«‹èµ·äº†ä¿¡ä»»


ps. ä»ç¬¬å››æ­¥å¯ä»¥çœ‹å‡º, HTTPS æ˜¯åŒ…å«å¯¹ç§°åŠ å¯†å’Œéå¯¹ç§°åŠ å¯†çš„.


åœ¨è¿™ä¹‹ä¸Šè¿˜æœ‰åŒå‘è®¤è¯, å¤šåŠ äº†å‡ ä¸ªæ­¥éª¤, å®¢æˆ·ç«¯ä¹Ÿç”¨å…¬é’¥ç§é’¥å°†è¯ä¹¦å‘é€ç»™æœåŠ¡ç«¯è®¤è¯, å¯ä»¥, ä½†æ²¡å•¥å¤§å¿…è¦.

å‡å¦‚ä¸­é—´æœ‰ä¸ªäºº, å®ƒæƒ³åšåäº‹, åœ¨ç¬¬äºŒæ­¥è·å–åˆ°è¯ä¹¦, å†å°†ä¸­é—´äººè‡ªå·±çš„è¯ä¹¦å‘é€ç»™å®¢æˆ·ç«¯, å®¢æˆ·ç«¯å»éªŒè¯:

1. éªŒè¯å¤±è´¥, å› ä¸ºå®ƒå¯¹ç³»ç»Ÿæ¥è¯´æ˜¯é™Œç”Ÿäºº, ç³»ç»Ÿä¸è®¤è¯†
2. éªŒè¯æˆåŠŸ, å¯èƒ½ç”¨æˆ·æ‰‹åŠ¨ç‚¹å‡»ä¿¡ä»»è¿‡è¯ä¹¦, æˆ–è€…ç³»ç»Ÿçš„è¯ä¹¦é­é‡æ³„æ¼

ç¬¬äºŒæ­¥çš„å‘ç”Ÿ, è®©ä¸€åˆ‡æœ‰è¶£èµ·æ¥, MITM å°±æ˜¯æŒ‡çš„å®ƒ. å®ƒä½¿å¯¹ HTTPS çš„æŠ“åŒ…å˜å¾—å¯èƒ½. å…·ä½“ MITM çš„åŸç†ä¹Ÿå¾ˆç®€å•, è¿™é‡Œä¸è¯´äº†.

æ¯”è¾ƒæœ‰ç”¨çš„æ˜¯åœ¨æ‰‹æœºä¸Š, å¯ä»¥ä½¿ç”¨ **åœˆX**, **Surge**, **Loon** ç­‰è½¯ä»¶æ‰§è¡Œè„šæœ¬, ç¯¡æ”¹ HTTPS è¯·æ±‚, è¿™å·²ç»éå¸¸æˆç†Ÿå¹¶ä¸”æœ‰å¾ˆå¤šå®ç”¨å·¥å…·äº†.

è¿™ç§è½¯ä»¶ä»¥æ·»åŠ  *VPN* çš„å½¢å¼åœ¨*åº”ç”¨å±‚*å·¥ä½œ, å®ƒä»¬ä½œä¸ºç³»ç»Ÿä»£ç†, æ•è·æ‰€æœ‰åº”ç”¨è¯·æ±‚, å†é…åˆ MITM, å¯ä»¥ç›´æ¥è§£æ HTTPS è¯·æ±‚.

è®²ä¸ªæœ€å¥½ç”¨çš„ä¾‹å­:

## jd/tb æ¯”ä»·ç¥å™¨

![jd&tb](1.png)

ä»£ç åœ¨ GitHub ä¸Šå¯ä»¥æœå¾—åˆ°: [tb_price.js](https://raw.githubusercontent.com/yichahucha/surge/master/tb_price.js)

ä»£ç æ¯”è¾ƒç®€å•, æ•´ä½“ä¸€çœ‹å¯ä»¥å¾—çŸ¥, å®ƒå¯¹ä¸¤ä¸ªè¯·æ±‚è¿›è¡Œäº†å¤„ç†, ä¿®æ”¹è¯·æ±‚å‚æ•°, ä¹Ÿæ›´æ”¹äº†è¿”å›ä¿¡æ¯, äºæ˜¯å‘ˆç°åˆ°æ‰‹æœºä¸Šå°±æ˜¯å®ƒæ›´æ”¹è¿‡çš„ä¿¡æ¯.

æ—¢ç„¶å¯ä»¥è¿™æ ·, é‚£ä¹ˆè‡ªå·±å°±å¯ä»¥åšç‚¹åäº‹æƒ…äº†. é¦–å…ˆç»ƒä¸ªæ‰‹:

## æ›´æ”¹å¾®åšçƒ­æœåˆ—è¡¨

ç»è¿‡å¯¹å¾®åšå›½é™…ç‰ˆçš„æŠ“åŒ…å¯ä»¥çœ‹åˆ°, çƒ­æœçš„è¯·æ±‚æ˜¯:

```
https://weibointl.api.weibo.cn/portal.php?ct=feed&a=search_topic&auth=xxx&c=weicoabroad&i=xxx&lang=en-CN&s=3f16726c&time=1606139954516&ua=iPhone12%2C1_iOS14.2_Weibo_intl._409_wifi&udid=xx-xx-xx-xx-xxx&user_id=xxx&version=409
```

å¯¹è¿”å›çš„ç»“æœä¸€è§£æå°±å¯ä»¥å†™å‡ºä»¥ä¸‹è¿™æ®µ hack ä»£ç :

```javascript
if ($request.url.includes('a=search_topic')) {
  const _data = $response.body
  console.log(_data)
  if (!_data) {
    console.log('no data!!!')
    console.log($request)
    console.log($response)
    $done()
  } else {
    const keywords = ['è”¡å¾å¤', 'è‚–æˆ˜', 'èŒƒä¸ä¸']
    let body = JSON.stringify(_data)
    keywords.forEach(keyword => {
      const regex = new RegExp(keyword, "gi")
      const result = "å£".repeat(keyword.length)
      body = body.replace(regex, result)
    })
    console.log(body)
    $done({body})
  }
} else {
  $done()
}
```

ä»£ç æŠŠæ‰€æœ‰çš„çƒ­æœåˆ—è¡¨ä¸­çš„*è”¡å¾å¤è‚–æˆ˜èŒƒä¸ä¸*éƒ½æ›¿æ¢ä¸º*å£*.

æˆ‘å¹³æ—¶ä¸ç”¨å¾®åšå›½é™…ç‰ˆ, ä¹°äº† VVebo pro ç‰ˆæœ¬, ç”¨å®ƒæ¯”è¾ƒå¤š, è¿™äº›ç¬¬ä¸‰æ–¹å¾®åšå®¢æˆ·ç«¯éƒ½æ˜¯æ‰’çš„å›½é™…ç‰ˆ API, æ‰€ä»¥ä¸Šé¢ä»£ç å¯ä»¥åŒæ ·è¿è¡Œ.

## ä½†æ˜¯ç¢°äº†ä¸€é¼»å­ç°

æ‰“å¼€æŠ“åŒ…å·¥å…·æŸ¥çœ‹, ç©ºç©ºå¦‚ä¹Ÿ, ä½¿ç”¨çš„æŠ“åŒ…å·¥å…·æœ‰: **HTTP Catcher**, **Charles**, **Stream**. å®Œå…¨æ²¡æœ‰æ¥å£çš„è¯·æ±‚, æµ‹è¯•å‘ç°æŠ“åŒ…å·¥å…·éƒ½æ˜¯æ­£å¸¸å¯ä»¥ç”¨çš„, é‚£ä¸ºä»€ä¹ˆæŠ“ä¸åˆ°åŒ…å‘¢?

é¦–å…ˆæ’é™¤ **SSL-Pinning**, å› ä¸ºå®ƒçš„åŸç†æ˜¯è½¯ä»¶å†…ç½®è¯ä¹¦, è¿›è¡Œ https è¯·æ±‚æ—¶å¯¹æ¯”è¯ä¹¦, å¦‚æœ MITM çš„è¯ä¹¦æ˜¯å¯¹ä¸ä¸Šçš„, è¯·æ±‚ä¹Ÿå°±ä¼šå¤±è´¥. å› ä¸º VVebo å®¢æˆ·ç«¯èƒ½å¤Ÿæ­£å¸¸å®Œæˆè¯·æ±‚, æ‰€ä»¥æ’é™¤äº†è¿™ç§å¯èƒ½.

ä¼šä¸ä¼šå¼€å‘è€…ä» tcp å±‚ä¸‹æ‰‹, è‡ªå·±å°è£…é€šä¿¡åè®®å‘¢? è¿™éœ€è¦å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨çš„é…åˆ, å·¥ä½œé‡å¤§.

ç»è¿‡æœç´¢å‘ç°è¿™ä¸€ä¸ª[å¸–å­](https://www.v2ex.com/t/715477#reply48). ä½œè€…è¡¨è¾¾:

> æ™®é€šçš„æŠ“åŒ…å·¥å…·ä½¿ç”¨è®¾ç½®ç³»ç»Ÿä»£ç†çš„æ–¹å¼, è€Œæœ‰äº› app ä¼šæ— è§†ç³»ç»Ÿä»£ç†, å¼€å‘è€…ä¸€è¡Œä»£ç å¯ä»¥è§£å†³çš„äº‹

äºæ˜¯å‹¾èµ·äº†æˆ‘çš„å¥½å¥‡å¿ƒ, å¹¶ä¸”è´­ä¹°äº†ä»–çš„ `mitmproxy client`, é…åˆç”µè„‘ä¸Šçš„ `mitmproxy` (åŠå¹´å‰ç ”ç©¶è¿‡å®ƒ) è¿›è¡ŒæŠ“åŒ…. è¿™ä¸ªå·¥å…·åœ¨å®¢æˆ·ç«¯æ‹¦æˆª **TCP** å’Œ **UDP** è¯·æ±‚, å‘é€ç»™ç”µè„‘ä¸Šçš„ `mitmproxy`.

ç»è¿‡æµ‹è¯•, bingo, æœç„¶èƒ½æŠ“åˆ°åŒ…, ç¬é—´è§‰å¾—å¥½æœ‰è¶£å¹¶ä¸”è¿˜æœ‰ä¸¤ä¸ªç–‘é—®:

1. ä½œè€…è¯´çš„**ä¸€è¡Œä»£ç **æ˜¯æ€ä¹ˆå†™çš„
2. **ä¸€è¡Œä»£ç **å¯ä»¥è§£å†³, ä¸ºä»€ä¹ˆå¤§éƒ¨åˆ†åº”ç”¨éƒ½æ²¡æœ‰ç”¨

## ä¸€è¡Œä»£ç 

å¸¦ç€é—®é¢˜å»æœç´¢ `ios swift bypass system proxy` æœç„¶æœ‰æ•ˆæœ:

[how-to-bypass-proxy-in-ios-programmatically](https://stackoverflow.com/questions/28061353/how-to-bypass-proxy-in-ios-programmatically/48261195)

åŠå¹´å‰å°±å¸è½½äº† Xcode, å¹¶ä¸”ä¹Ÿæœ‰å¾ˆå‡ å¹´æ²¡å†™ iOS åŸç”Ÿäº†, è™½ç„¶ä»£ç èƒ½çœ‹æ‡‚, ä½†è¦å†™ä¸ª demo å¯å¤ªéš¾äº†, å…ˆä¸‹è½½ Xcode å§.

ç»è¿‡å‡ å°æ—¶çš„ä¸‹è½½å®‰è£…, ç»ˆäºæˆåŠŸå¯ä»¥æ’¸ä»£ç äº†:

```swift
var proxyDict = [AnyHashable : Any]()
@IBAction func callAPI(_ sender: UIButton) {
  let sessionConfig = URLSessionConfiguration.default
  sessionConfig.connectionProxyDictionary = proxyDict
  let session = URLSession.init(configuration: sessionConfig, delegate: nil, delegateQueue: OperationQueue.current)
  let url = URL(string: "https://v2hot-server-git-master.faichou.now.sh/v2hot")!
  let task = session.dataTask(with: url, completionHandler: { data, response, error in
    print(error)
    print(response)
    // Check the response
    if (error == nil) {
      DispatchQueue.main.async {
        self.alertString(s: "è¯·æ±‚æˆåŠŸ")
      }
      print(response)
    } else {
      DispatchQueue.main.async {
        self.alertString(s: "è¯·æ±‚å¤±è´¥")
      }
    }
  })
  task.resume()
}
func alertString(s: String) {
  let alert = UIAlertController(title: s, message: s, preferredStyle: .alert)
  alert.addAction(UIAlertAction(title: "OK", style: .default, handler: { action in
    switch action.style{
    case .default:
      print("default")
    case .cancel:
      print("cancel")
    case .destructive:
      print("destructive")
  }}))
  self.present(alert, animated: true, completion: nil)
}
```

ä¸è¦å°å·§ä»¥ä¸Šä»£ç , å†™äº†æˆ‘ä¸€ä¸ªå¤šå°æ—¶, é¦–å…ˆé‡åˆ°äº†ä¸èƒ½åœ¨ `completionHandler` ä¸­ç›´æ¥ `alert` çš„é—®é¢˜, è€Œæ˜¯éœ€è¦å°†å®ƒæ”¾åœ¨ `main queue` ä¸­æ‰§è¡Œ; å…¶æ¬¡é‡åˆ°äº†é—­åŒ…æ•è·å˜é‡é—®é¢˜, ä¸èƒ½ç›´æ¥åœ¨é—­åŒ…ä¸­æ”¹å˜ä¸€ä¸ªå¤–éƒ¨å˜é‡, ç„¶åä½¿ç”¨å®ƒ, åˆ°ç°åœ¨æˆ‘ä¹Ÿä¸çŸ¥é“æ€ä¹ˆæ­£ç¡®æ”¹æ­£, äºæ˜¯æˆ‘çš„ workaround æ˜¯å°†å˜é‡å½“å‚æ•°ä¼ ç»™äº†æ–¹æ³•ä¸­, æ–¹æ³•é‡Œå» `alert`. ä½†æ„Ÿè§‰è¿™æ ·å†™å¥½æµªè´¹å•Š! è¿™ä¹ˆæƒ³æ¥, js ç®€ç›´æ˜¯å¤ªç®€å•äº†, å†™ js ç®€ç›´å¤ªå¹¸ç¦äº†.

ä»£ç è·‘èµ·æ¥, é€šè¿‡å¢åŠ æˆ–å»æ‰è¿™ä¸€è¡Œä»£ç :

```
sessionConfig.connectionProxyDictionary = proxyDict
```

ç»æµ‹è¯•å‘ç°, å»æ‰è¿™è¡Œä»£ç , å¯ä»¥æˆåŠŸæŠ“åŒ…, åŠ ä¸Šè¿™è¡Œä»£ç , æ— æ³•æŠ“åŒ…. å¹¶ä¸”å’Œ VVebo è¡¨ç°çš„ä¸€è‡´: åœ¨ Loon çš„æœ€è¿‘è¯·æ±‚ä¸­, *https* çš„è¯·æ±‚å˜æˆäº† *tcp* è¯·æ±‚:

![2](2.jpg)

![3](3.jpg)

å¹¶ä¸”å½“æ— æ³•æŠ“åŒ…æ—¶å€™, ä½¿ç”¨ `mitmproxy client` æ˜¯å¯ä»¥æŠ“åŒ…çš„:

![4](4.jpg)

## ä¸€è¡Œä»£ç è¿™ä¹ˆç®¡ç”¨, ä¸ºä»€ä¹ˆå¤§å®¶éƒ½ä¸ç”¨

è¿™ä¸ªé—®é¢˜ä»¤æˆ‘ç™¾æ€ä¸å¾—å…¶è§£, æˆ‘çŒœæµ‹ä¸‰ç§å¯èƒ½:

1. å¤§å®¶éƒ½è¿˜ä¸çŸ¥é“å±é™©, æˆ–è€…çŸ¥é“å±é™©éœ€è¦é˜²èŒƒçš„(æ”¯ä»˜/é“¶è¡Œç±»/èŠå¤©)éƒ½é‡‡ç”¨å…¶ä»–æ–¹å¼å¤„ç†äº†
2. ç½‘ç»œè¯·æ±‚ä¸ä½¿ç”¨ URLSession, ç”¨å…¶ä»–çš„ç½‘ç»œè¯·æ±‚æ¡†æ¶æ¯”å¦‚ *Alamofire* æ²¡æœ‰è¿™åŠŸèƒ½
3. ç¨‹åºå±Šçš„é“å¾·åº•çº¿

æ¯•ç«Ÿä½¿ç”¨ SSL-Pinning çš„éƒ½æ˜¯æœ‰æ–¹æ³•ç ´è§£çš„, æ‰€ä»¥é“é«˜ä¸€å°ºé­”é«˜ä¸€ä¸ˆ.
