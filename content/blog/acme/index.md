---
title: "ä½¿ç”¨ ACME ç”³è¯·å®‰è£…è¯ä¹¦"
date: "2023-03-19"
category: "dev"
emoji: "ðŸ…"
---

## 1. å®‰è£… acme

ä½¿ç”¨ acme å‘½ä»¤è¡Œå·¥å…·æ¥ç”³è¯·å®‰è£…è¯ä¹¦

```bash
$ curl https://get.acme.sh | sh
```

## 2. å®‰è£… socat

> socat æ˜¯ä¸€æ¬¾ Linux ä¸‹çš„å·¥å…·è½¯ä»¶ï¼Œå¯ä»¥åœ¨ä¸¤ä¸ªä¸åŒçš„æ•°æ®æµä¹‹é—´å»ºç«‹è¿žæŽ¥ï¼Œå®žçŽ°æ•°æ®ä¼ è¾“ã€è½¬æ¢å’Œå¤„ç†ç­‰åŠŸèƒ½

acme ä¾èµ– socat, æ‰€ä»¥å®‰è£…:

```bash
$ apt install socat
```

## 3. æ·»åŠ è½¯è¿žæŽ¥

æ·»åŠ åˆ° bin ä¸‹é¢, å¯ä»¥ç›´æŽ¥ä½¿ç”¨ acme.sh è„šæœ¬è€Œä¸éœ€è¦åŠ ä¸Šè·¯å¾„

```bash
$ ln -s /root/.acme.sh/acme.sh /usr/local/bin/acme.sh
```

## 4. æ³¨å†Œè´¦å·

```bash
$ acme.sh -register-account -m my@example.com
```

é»˜è®¤ä½¿ç”¨ ZeroSSL, æ³¨å†ŒæˆåŠŸä¼šæç¤º

## 5. å¼€æ”¾ 80 ç«¯å£

å› ä¸ºç”³è¯·è¯ä¹¦æ—¶å€™éœ€è¦éªŒè¯(ä½¿ç”¨ standalone æ–¹å¼), è¯ä¹¦é¢å‘æœºæž„ä¼šé€šè¿‡ç”³è¯·è¯ä¹¦çš„åŸŸåæ¥è®¿é—®ä¸€ä¸ªå­—ç¬¦ä¸², ç”¨æ¥æµ‹è¯•ä½ æ˜¯å¦æ˜¯åŸŸåçš„ä¸»äºº. æ‰€ä»¥éœ€è¦ 80 ç«¯å£.

```bash
$ ufw allow 80
```

## 6. ç”³è¯·è¯ä¹¦

```bash
$ acme.sh -issue -d test.faichou.com -standalone -k ec-256
```

ç”³è¯·è¿‡ç¨‹ä¸­å¯ä»¥ç”¨æµè§ˆå™¨æ‰“å¼€åŸŸåçœ‹åˆ°æœ‰ä¸€ä¼ éšæœºå­—ç¬¦ä¸², ç”³è¯·ç»“æŸåŽå†è®¿é—®åŸŸåå°±æ²¡æœ‰äº†, è¿™å°±æ˜¯ä½¿ç”¨ acme åˆ›å»ºäº†ä¸€ä¸ªæœåŠ¡å™¨, è¯ä¹¦é¢å‘æœºæž„ç”¨æ¥éªŒè¯çš„è¿‡ç¨‹.

## 7. åˆ‡æ¢ CA

æœ‰æ—¶å€™æŽ’é˜Ÿå¾ˆæ…¢, éœ€è¦åˆ‡æ¢ä¸€ä¸‹ CA

```bash
$ acme.sh -set-default-ca -server letsencrypt
```

ç„¶åŽå†é‡æ–°æ‰§è¡Œç¬¬ 6 æ­¥.


ç”³è¯·å®Œè¯ä¹¦åŽä¼šæœ‰å‡ ä¸ªæ–‡ä»¶:

- cert æ–‡ä»¶: æ˜¯ç”³è¯·çš„ SSL è¯ä¹¦ï¼ŒåŒ…å«äº†ç½‘ç«™çš„å…¬é’¥ä¿¡æ¯ä»¥åŠè¯ä¹¦æŒæœ‰è€…çš„èº«ä»½ä¿¡æ¯, ä¸€èˆ¬ç”¨æ¥å®‰è£…åˆ° Web æœåŠ¡å™¨, ç”¨äºŽåŠ å¯†ä¼ è¾“æ•°æ®.
- cert.key æ–‡ä»¶: æ˜¯è¯ä¹¦çš„ç§é’¥æ–‡ä»¶, ç”¨æ¥å’Œå…¬é’¥ä¸€èµ·å¯¹é€šä¿¡æ•°æ®è¿›è¡ŒåŠ å¯†æˆ–è§£å¯†ç­‰æ“ä½œ, ä¸€èˆ¬ä¿å¯†å¹¶å¦¥å–„ä¿å­˜.
- Intermediate CA cert: ä¸­é—´è¯ä¹¦, ç”¨äºŽæž„å»ºè¯ä¹¦é“¾, ä¿è¯è¯ä¹¦çš„å¯ä¿¡åº¦.
- chain certs æ–‡ä»¶(fullchain.cer): ç”±äºŽ ACME è¯ä¹¦ç”³è¯·æ˜¯éœ€è¦ç»è¿‡ä¸­é—´ CA çš„ç­¾å‘, ç”Ÿæˆçš„è¯ä¹¦æ–‡ä»¶ä¸­è¿˜åŒ…å«äº†ä¸­é—´ CA å’Œæ ¹ CA çš„è¯ä¹¦ä¿¡æ¯, è¿™äº›è¯ä¹¦ä¹Ÿæ”¾åœ¨äº†è¯¥æ–‡ä»¶ä¸­. Web æœåŠ¡å™¨éœ€è¦å°†è¯¥æ–‡ä»¶ä¸Žè¯ä¹¦é…åˆä½¿ç”¨, ä»¥ä¾¿æž„å»ºå®Œæ•´çš„è¯ä¹¦é“¾æ¡, ç¡®ä¿å®¢æˆ·ç«¯èƒ½å¤Ÿæ­£ç¡®è¯†åˆ«è¯ä¹¦çš„æœ‰æ•ˆæ€§.

## 8. å®‰è£…åˆ° nginx

```bash
acme.sh --install-cert -d example.com \
--key-file       /path/to/keyfile/in/nginxconfig/cert.key  \
--fullchain-file /path/to/fullchain/nginxconfig/fullchain.cer \
--reloadcmd     "service nginx force-reload"
```



é™¤æ­¤ä¹‹å¤–, è¯ä¹¦é»˜è®¤ 90 å¤©æœ‰æ•ˆ, 90 å¤©åŽä¼šè¿‡æœŸ, å¦‚æžœä½¿ç”¨ acme.sh [ä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬æ¯å¤© renew](https://github.com/acmesh-official/acme.sh#2-or-install-from-git), ä¸éœ€è¦è‡ªå·±å†™ corntab:

```
0 0 * * * "/home/user/.acme.sh"/acme.sh --cron --home "/home/user/.acme.sh" > /dev/null
```
